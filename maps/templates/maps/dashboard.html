<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoMap Admin Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom-symbol-picker.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <meta name="csrf-token" content="{% csrf_token %}">
</head>
<body>
    {% csrf_token %}
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div>
                    <h1 class="dashboard-title">
                        <i class="fas fa-map-marked-alt"></i>
                        GeoMap Dashboard
                    </h1>
                    <p class="dashboard-subtitle">Manage GeoJSON Files and Map Layers</p>
                </div>
                <div class="header-actions">
                    <span class="user-info">
                        <i class="fas fa-user"></i>
                        Welcome, {{ user.username }}
                    </span>
                    <a href="{% url 'admin_logout' %}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="total-files">0</span>
                <span class="stat-label">Total Files</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="active-files">0</span>
                <span class="stat-label">Active Files</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="total-points">0</span>
                <span class="stat-label">Total Points</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">
                    <a href="/embed/" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt"></i>
                        View Map
                    </a>
                </span>
                <span class="stat-label">Embedded Map</span>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="content-section">
            <h2 class="section-title">
                <i class="fas fa-cloud-upload-alt"></i>
                Upload GeoJSON Files
            </h2>
            
            <div class="upload-section">
                <div class="upload-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <div class="upload-text">Drag & drop files or click to select GeoJSON files</div>
                <input type="file" id="file-upload" class="file-input" 
                       accept=".geojson,.json,application/json,application/geo+json" multiple>
                <button class="btn btn-primary btn-lg" onclick="document.getElementById('file-upload').click()">
                    <i class="fas fa-plus"></i>
                    Select Files
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    Supported: .geojson, .json | Max: 50MB per file
                </p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- GeoJSON Files Management -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-layer-group"></i>
                        GeoJSON Files Management
                    </h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="refreshFileList()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" onclick="showCreateModal()">
                            <i class="fas fa-plus-circle"></i>
                            Add New
                        </button>
                    </div>
                </div>
                
                <div class="files-table-container">
                    <table class="files-table" id="geojson-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Map Type</th>
                                <th>File</th>
                                <th>Features</th>
                                <th>Color</th>
                                <th>Active</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="geojson-list">
                            <tr>
                                <td colspan="8" class="loading-container">
                                    <div class="loading"></div>
                                    <p>Loading data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <a href="/admin/maps/geojsonfile/" class="btn btn-secondary" target="_blank">
                        <i class="fas fa-cog"></i>
                        Django Admin
                    </a>
                </div>
            </div>

            <!-- Symbol Management -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title-area">
                        <h2 class="section-title">
                            <i class="fas fa-image"></i>
                            Symbol Management
                        </h2>
                        <div class="section-description">
                            Manage custom symbols for map markers (24x24 PNG format)
                        </div>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="refreshSymbolList()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showUploadSymbolModal()">
                            <i class="fas fa-upload"></i>
                            Upload Symbol
                        </button>
                    </div>
                </div>

                <!-- Symbol Stats -->
                <div class="symbol-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-number" id="total-symbols">0</span>
                            <span class="stat-label">Total Symbols</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-number" id="symbol-categories">0</span>
                            <span class="stat-label">Categories</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Format</span>
                            <span class="stat-subtext">24x24 PNG</span>
                        </div>
                    </div>
                </div>

                <div class="symbols-grid" id="symbols-container">
                    <div class="loading-container">
                        <div class="loading"></div>
                        <p>Loading symbols...</p>
                    </div>
                </div>
            </div>

            <!-- Layer Control -->
            <div class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-eye"></i>
                    Map Layer Control
                </h2>
                
                <div class="layer-control-panel">
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="selectAllLayers()">
                            <i class="fas fa-check-double"></i>
                            Select All
                        </button>
                    </div>
                    
                    <div id="layer-control-list">
                        <div class="loading-container" style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p>Loading layer controls...</p>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Instructions:</strong><br>
                        • Use checkboxes to toggle layer visibility on the map<br>
                        • Changes are synchronized in real-time with the map<br>
                        • Disabled layers will not be displayed on the embedded map
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="content-section" style="margin-top: 30px;">
            <h2 class="section-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <a href="/admin/" class="btn btn-primary" target="_blank">
                    <i class="fas fa-user-shield"></i>
                    Django Admin
                </a>
                <a href="/embed/" class="btn btn-success" target="_blank">
                    <i class="fas fa-map"></i>
                    View Map
                </a>
                <a href="/api/" class="btn btn-info" target="_blank">
                    <i class="fas fa-code"></i>
                    API Docs
                </a>
                <button class="btn btn-secondary" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Embed Code Section -->
        <div class="content-section" style="margin-top: 30px;">
            <h2 class="section-title">
                <i class="fas fa-code"></i>
                Embed Map Code
            </h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                <p><strong>To embed this map in another website, use this code:</strong></p>
                <pre style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.9rem;"><code>&lt;iframe 
    src="http://127.0.0.1:8000/embed/" 
    width="100%" 
    height="600px" 
    frameborder="0"
    style="border: none; border-radius: 8px;"&gt;
&lt;/iframe&gt;</code></pre>
                <button class="btn btn-primary" onclick="navigator.clipboard.writeText(document.querySelector('pre code').textContent)">
                    <i class="fas fa-copy"></i>
                    Copy Code
                </button>
            </div>
        </div>
    </div>

    <!-- CRUD Modal -->
    <div id="crudModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New GeoJSON File</h3>
                <span class="close" onclick="closeCrudModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="crud-form" enctype="multipart/form-data">
                    <input type="hidden" id="file-id">
                    
                    <div class="form-group">
                        <label for="file-name">Name:</label>
                        <input type="text" id="file-name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-description">Description:</label>
                        <textarea id="file-description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-map-type">Map Type:</label>
                        <select id="file-map-type" name="map_type" required>
                            <option value="embed">Embed Map</option>
                            <option value="embed_vn">Embed VN Map</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-custom-symbol">Map Symbol:</label>
                        <div id="file-custom-symbol-picker"></div>
                        <input type="hidden" id="file-custom-symbol" name="custom_symbol" value="">
                    </div>
                    
                    <div class="form-group" id="file-upload-group">
                        <label for="geojson-file">GeoJSON File:</label>
                        <input type="file" id="geojson-file" name="file" accept=".geojson,.json">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="file-active" name="is_active" checked>
                            Active
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'js/admin_dashboard.js' %}"></script>
    
    <!-- Drag & Drop File Upload -->
    <script>
        // Drag and drop functionality
        const uploadSection = document.querySelector('.upload-section');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#764ba2';
            uploadSection.style.backgroundColor = 'rgba(118, 75, 162, 0.2)';
        });
        
        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#667eea';
            uploadSection.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#667eea';
            uploadSection.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
            
            const files = Array.from(e.dataTransfer.files);
            const fileInput = document.getElementById('file-upload');
            
            // Simulate file input selection
            Object.defineProperty(fileInput, 'files', {
                value: e.dataTransfer.files,
                writable: false
            });
            
            // Trigger file upload
            window.geoManager.handleFileUpload();
        });
    </script>

    <!-- Upload Symbol Modal -->
    <div id="uploadSymbolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-upload"></i>
                    <div>
                        <h3>Upload Custom Symbol</h3>
                        <p class="modal-subtitle">Add a new symbol for map markers</p>
                    </div>
                </div>
                <span class="modal-close" onclick="closeUploadSymbolModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Upload Info -->
                <div class="upload-info">
                    <div class="info-item">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Supported formats:</strong> JPEG, PNG, GIF, WebP
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-magic"></i>
                        <div>
                            <strong>Auto-conversion:</strong> Images will be resized to 24x24 PNG
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-palette"></i>
                        <div>
                            <strong>Transparency:</strong> PNG/GIF transparency is preserved
                        </div>
                    </div>
                </div>

                <form id="upload-symbol-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="symbol-name">Symbol Name *</label>
                        <input type="text" id="symbol-name" name="name" required
                               placeholder="Enter symbol name (e.g., Hospital, Restaurant)">
                        <span class="form-help">This name will be displayed in the symbol picker</span>
                    </div>

                    <div class="form-group">
                        <label for="symbol-image">Symbol Image *</label>
                        <div class="file-upload-area" id="symbol-upload-area">
                            <div class="upload-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-text">Click to select or drag & drop image</div>
                            <input type="file" id="symbol-image" name="symbol_image" accept="image/*" required>
                        </div>
                        <small class="form-help">Supported: JPEG, PNG, GIF, WebP. Will be automatically resized to 24x24px.</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeUploadSymbolModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload & Convert</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Symbol Picker Scripts -->
    <script src="{% static 'js/custom-symbol-picker.js' %}"></script>

    <script>
        // Initialize custom symbol picker when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, custom symbol picker will be initialized when modal opens');
        });

        // Function to initialize custom symbol picker when modal opens
        function initializeCustomSymbolPicker(defaultSymbol = null) {
            console.log('Initializing custom symbol picker with default:', defaultSymbol);
            console.log('Container exists:', !!document.getElementById('file-custom-symbol-picker'));

            try {
                // Initialize custom symbol picker for the modal
                window.customSymbolPicker = initCustomSymbolPicker('file-custom-symbol-picker', {
                    defaultSymbol: defaultSymbol,
                    showLabel: false,
                    onSymbolChange: function(symbolId, symbolData) {
                        console.log('Custom symbol changed callback triggered:', symbolId, symbolData);

                        // Update hidden input
                        const customSymbolInput = document.getElementById('file-custom-symbol');

                        if (customSymbolInput) customSymbolInput.value = symbolId || '';
                        console.log('Updated custom symbol value:', symbolId);
                    }
                });
                console.log('Custom symbol picker initialized successfully');
                return true;
            } catch (error) {
                console.error('❌ Error initializing custom symbol picker:', error);
                return false;
            }
        }

        // Function to reinitialize custom symbol picker when modal opens
        function reinitializeCustomSymbolPicker(defaultSymbol = null) {
            if (window.customSymbolPicker) {
                // Reset picker
                window.customSymbolPicker.setSymbol(defaultSymbol);
            } else {
                // Initialize if not exists
                initializeCustomSymbolPicker(defaultSymbol);
            }
        }

        // Symbol Management Functions
        async function loadSymbols() {
            try {
                const response = await fetch('/api/custom-symbols/');
                const data = await response.json();

                if (data.status === 'success') {
                    displaySymbols(data.symbols);
                } else {
                    showMessage('Failed to load symbols', 'error');
                }
            } catch (error) {
                console.error('Error loading symbols:', error);
                showMessage('Error loading symbols', 'error');
            }
        }

        function displaySymbols(symbols) {
            const container = document.getElementById('symbols-container');

            // Update stats
            updateSymbolStats(symbols);

            if (symbols.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-image" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                        <p>No symbols uploaded yet</p>
                        <p style="color: #666; font-size: 0.9rem;">Click "Upload Symbol" above to add your first symbol</p>
                    </div>
                `;
                return;
            }

            const symbolsHtml = symbols.map(symbol => `
                <div class="symbol-card">
                    <img src="${symbol.image_url}" alt="${symbol.name}" class="symbol-image">
                    <div class="symbol-name">${symbol.name}</div>
                    <div class="symbol-category">${symbol.category}</div>
                    <div class="symbol-actions">
                        <button class="symbol-delete-btn" onclick="deleteSymbol(${symbol.id}, '${symbol.name}')" title="Delete Symbol">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = symbolsHtml;
        }

        function updateSymbolStats(symbols) {
            // Update total symbols
            document.getElementById('total-symbols').textContent = symbols.length;

            // Update categories count
            const categories = new Set(symbols.map(s => s.category));
            document.getElementById('symbol-categories').textContent = categories.size;
        }

        function showUploadSymbolModal() {
            document.getElementById('uploadSymbolModal').style.display = 'flex';
            document.getElementById('upload-symbol-form').reset();
        }

        function closeUploadSymbolModal() {
            document.getElementById('uploadSymbolModal').style.display = 'none';
        }

        function refreshSymbolList() {
            loadSymbols();
        }

        async function deleteSymbol(symbolId, symbolName) {
            if (!confirm(`Are you sure you want to delete the symbol "${symbolName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-symbol/${symbolId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('Symbol deleted successfully', 'success');
                    loadSymbols();
                } else {
                    showMessage(data.message || 'Failed to delete symbol', 'error');
                }
            } catch (error) {
                console.error('Error deleting symbol:', error);
                showMessage('Error deleting symbol', 'error');
            }
        }

        // Initialize symbols on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            
            // Ensure upload symbol modal is hidden on page load
            const uploadModal = document.getElementById('uploadSymbolModal');
            if (uploadModal) {
                uploadModal.style.display = 'none';
            }
        });

        // Upload symbol form handling
        document.getElementById('upload-symbol-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/upload-symbol/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('Symbol uploaded and converted successfully!', 'success');
                    closeUploadSymbolModal();
                    loadSymbols();
                } else {
                    showMessage(data.message || 'Upload failed', 'error');
                }
            } catch (error) {
                console.error('Error uploading symbol:', error);
                showMessage('Error uploading symbol', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // File upload area interactions
        const symbolUploadArea = document.getElementById('symbol-upload-area');
        const symbolFileInput = document.getElementById('symbol-image');

        symbolUploadArea.addEventListener('click', () => {
            symbolFileInput.click();
        });

        symbolFileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const fileName = file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                symbolUploadArea.querySelector('.upload-text').textContent = `${fileName} (${fileSize} MB)`;
                symbolUploadArea.classList.add('has-file');
            }
        });

        // Drag and drop for symbol upload
        symbolUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            symbolUploadArea.classList.add('dragover');
        });

        symbolUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            symbolUploadArea.classList.remove('dragover');
        });

        symbolUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            symbolUploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                symbolFileInput.files = files;
                const file = files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                symbolUploadArea.querySelector('.upload-text').textContent = `${fileName} (${fileSize} MB)`;
                symbolUploadArea.classList.add('has-file');
            }
        });
    </script>
</body>
</html>